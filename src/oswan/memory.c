////////////////////////////////////////////////////////////////////////////////
// Memory
////////////////////////////////////////////////////////////////////////////////
// Notes: need to optimize cpu_writemem20
//
//
//
//
//
//////////////////////////////////////////////////////////////////////////////

#include <string.h>
#include <io.h>
#include "rom.h"
#include "./nec/nec.h"
#include "gpu.h"
#include "psram_spi.h"

////////////////////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////////////////////
//
//
//
//
//
//
//
////////////////////////////////////////////////////////////////////////////////
#define IO_ROM_BANK_BASE_SELECTOR    0xC0


static uint8 *ws_rom;
uint8 internalRam[0x10000];


uint16 ws_rom_checksum;

uint32 sramAddressMask;
uint32 externalEepromAddressMask;
uint32 romAddressMask;
static uint32 romSize;



////////////////////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////////////////////
//
//
//
//
//
//
//
////////////////////////////////////////////////////////////////////////////////
void cpu_writemem20(uint32_t addr, uint8_t value) {
    uint32 offset = addr & 0xffff;
    uint32 bank = addr >> 16;

    // 0 - RAM - 16 KB (WS) / 64 KB (WSC) internal RAM
    if (!bank) {
        ws_gpu_write_byte(offset, value);
//		ws_audio_write_byte(offset,value);
    } else
        // 1 - SRAM (cart)
    if (bank == 1)
        write8psram((1024 << 10) + (offset & sramAddressMask), value);
//		ws_staticRam[offset&sramAddressMask]=value;

    // other banks are read-only
}

////////////////////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////////////////////
//
//
//
//
//
//
//
////////////////////////////////////////////////////////////////////////////////
uint8_t cpu_readmem20(uint32_t addr) {
    uint32 offset = addr & 0xffff;
    uint32 bank = addr >> 16;

    switch (bank) {
        case 0:        // 0 - RAM - 16 KB (WS) / 64 KB (WSC) internal RAM
            if (ws_gpu_operatingInColor || offset < 0x4000)
                return (internalRam[offset]);
            return (0xff);

        case 1:    // 1 - SRAM (cart)
            return read8psram((1024 << 10) + (offset & sramAddressMask));
//				return ws_staticRam[offset&sramAddressMask];
        case 2:
        case 3:
            return ws_rom[offset + ((ws_ioRam[IO_ROM_BANK_BASE_SELECTOR + bank] & ((romSize >> 16) - 1)) << 16)];
        default: {
            unsigned int romBank = (256 - (((ws_ioRam[IO_ROM_BANK_BASE_SELECTOR] & 0xf) << 4) | (bank & 0xf)));
            return ws_rom[(unsigned) (offset + romSize - (romBank << 16))];
        }
    }
    return (0xff);
}

////////////////////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////////////////////
//
//
//
//
//
//
//
////////////////////////////////////////////////////////////////////////////////
void ws_memory_init(uint8 *rom, uint32 wsRomSize) {
    ws_romHeaderStruct *ws_romHeader;

    ws_rom = rom;
    romSize = wsRomSize;
    ws_romHeader = ws_rom_getHeader(ws_rom, romSize);
    ws_rom_checksum = ws_romHeader->checksum;

    sramAddressMask = ws_rom_sramSize(ws_rom, romSize) - 1;
    externalEepromAddressMask = ws_rom_eepromSize(ws_rom, romSize) - 1;
    romAddressMask = romSize - 1;

    if (ws_romHeader->minimumSupportSystem == WS_SYSTEM_COLOR)
        ws_gpu_operatingInColor = 1;

}

////////////////////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////////////////////
//
//
//
//
//
//
//
////////////////////////////////////////////////////////////////////////////////
void ws_memory_reset(void) {
    memset(internalRam, 0, 0x10000);
//	memset(ws_staticRam,0,0x10000);
}

////////////////////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////////////////////
//
//
//
//
//
//
//
////////////////////////////////////////////////////////////////////////////////
void ws_memory_done(void) {
#if 0
    free(ws_rom);
    free(ws_staticRam);
    free(internalRam);
    free(externalEeprom);
#endif
}
////////////////////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////////////////////
//
//
//
//
//
//
//
////////////////////////////////////////////////////////////////////////////////
uint8 *memory_getRom(void) {
    return (ws_rom);
}
////////////////////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////////////////////
//
//
//
//
//
//
//
////////////////////////////////////////////////////////////////////////////////
uint32 memory_getRomSize(void) {
    return (romSize);
}
////////////////////////////////////////////////////////////////////////////////
//
////////////////////////////////////////////////////////////////////////////////
//
//
//
//
//
//
//
////////////////////////////////////////////////////////////////////////////////
uint16 memory_getRomCrc(void) {
    return (ws_rom_checksum);
}

